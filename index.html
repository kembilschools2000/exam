<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNILAG Post-UTME CBT Simulator</title>
<style>
  body {font-family:'Segoe UI',sans-serif;background:#f3f6fc;margin:0;}
  header {background:#004aad;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center;}
  header h2{margin:0;font-size:18px;}
  .camera-box{width:3cm;height:3cm;border:2px solid #fff;border-radius:10px;overflow:hidden;background:#000;}
  video{width:100%;height:100%;object-fit:cover;}
  .container{max-width:700px;margin:30px auto;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:20px;}
  .hidden{display:none;}
  button{background:#004aad;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;}
  button:hover{background:#0066ff;}
  .question{margin-top:15px;}
  .options label{display:block;margin:6px 0;background:#eef3ff;padding:8px;border-radius:5px;cursor:pointer;}
  .timer{text-align:right;color:#d32f2f;font-weight:bold;}
</style>
</head>
<body>

<header>
  <h2>UNILAG Post-UTME CBT Simulator</h2>
  <div class="camera-box">
    <video id="camera" autoplay muted></video>
  </div>
</header>

<div class="container" id="login-screen">
  <h3>Candidate Login</h3>
  <input type="text" id="name" placeholder="Full Name" style="width:100%;padding:8px;margin:5px 0;"><br>
  <input type="email" id="email" placeholder="Email" style="width:100%;padding:8px;margin:5px 0;"><br>
  <button id="loginBtn">Proceed</button>
</div>

<div class="container hidden" id="instructions">
  <h3>Exam Instructions</h3>
  <p>Welcome, <span id="studentName"></span>.</p>
  <ul>
    <li>Keep your face visible at all times.</li>
    <li>Do not leave the screen or look away frequently.</li>
    <li>Exam duration: 5 minutes.</li>
  </ul>
  <button id="startExamBtn">Start Exam</button>
</div>

<div class="container hidden" id="exam-screen">
  <div class="timer" id="timer">Time: 05:00</div>
  <div id="question-box"></div>
  <button id="next-btn">Next</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
<script>
const camera = document.getElementById("camera");
const loginScreen=document.getElementById("login-screen");
const instructionScreen=document.getElementById("instructions");
const examScreen=document.getElementById("exam-screen");
const studentNameDisplay=document.getElementById("studentName");
const timerDisplay=document.getElementById("timer");
const questionBox=document.getElementById("question-box");

let score=0, malpracticeCount=0, current=0, timer, time=5*60;
let lastFrameTime=Date.now();

const questions=[
 {q:"What is the capital of Nigeria?",options:["Lagos","Abuja","Kano","Ibadan"],correct:1},
 {q:"2 + 2 = ?",options:["3","4","5","6"],correct:1},
 {q:"Which planet is known as the Red Planet?",options:["Earth","Venus","Mars","Jupiter"],correct:2}
];

document.getElementById("loginBtn").onclick=()=>{
 const name=document.getElementById("name").value.trim();
 const email=document.getElementById("email").value.trim();
 if(!name||!email)return alert("Enter name and email");
 studentNameDisplay.textContent=name;
 loginScreen.classList.add("hidden");
 instructionScreen.classList.remove("hidden");
};

document.getElementById("startExamBtn").onclick=()=>{
 instructionScreen.classList.add("hidden");
 examScreen.classList.remove("hidden");
 startExam();
};

function startExam(){
 loadQuestion();
 startTimer();
 startCameraProctoring();
 setupTabMonitor();
}

function loadQuestion(){
 const q=questions[current];
 questionBox.innerHTML=`
  <div class="question">
   <h4>Question ${current+1} of ${questions.length}</h4>
   <p>${q.q}</p>
   <div class="options">
    ${q.options.map((opt,i)=>`<label><input type="radio" name="option" value="${i}"> ${opt}</label>`).join('')}
   </div>
  </div>`;
}

document.getElementById("next-btn").onclick=()=>{
 const selected=document.querySelector("input[name='option']:checked");
 if(!selected)return alert("Select an answer");
 const val=parseInt(selected.value);
 if(val===questions[current].correct)score++;
 current++;
 if(current<questions.length)loadQuestion(); else finishExam();
};

function startTimer(){
 timer=setInterval(()=>{
   let m=Math.floor(time/60),s=time%60;
   timerDisplay.textContent=`Time: ${m}:${s.toString().padStart(2,'0')} | ⚠️ Malpractice: ${malpracticeCount}`;
   if(time<=0)finishExam();
   time--;
 },1000);
}

// --- TAB SWITCH OR MINIMIZE DETECTION ---
function setupTabMonitor(){
 document.addEventListener("visibilitychange",()=>{
   if(document.hidden){
     malpracticeCount++;
     alert("⚠️ Malpractice detected: Tab switch or minimize!");
   }
 });
 window.addEventListener("blur",()=>{
   malpracticeCount++;
   console.warn("⚠️ Malpractice: Window focus lost!");
 });
}

// --- CAMERA PROCTORING ---
async function startCameraProctoring(){
 try{
   const stream=await navigator.mediaDevices.getUserMedia({video:true});
   camera.srcObject=stream;

   await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models');

   let lastFrame = null;

   setInterval(async()=>{
     const detections=await faceapi.detectAllFaces(camera,new faceapi.TinyFaceDetectorOptions());
     
     // 1️⃣ Face presence check
     if(detections.length===0){
       malpracticeCount++;
       console.warn("⚠️ Malpractice: No face detected!");
     } else if(detections.length>1){
       malpracticeCount++;
       console.warn("⚠️ Malpractice: Multiple faces detected!");
     }

     // 2️⃣ Freeze / camera cover check
     const canvas = document.createElement("canvas");
     canvas.width=camera.videoWidth;
     canvas.height=camera.videoHeight;
     const ctx = canvas.getContext("2d");
     ctx.drawImage(camera,0,0,canvas.width,canvas.height);
     const frame = ctx.getImageData(0,0,canvas.width,canvas.height).data;

     if(lastFrame){
       let diff=0;
       for(let i=0;i<frame.length;i+=50){ 
         diff += Math.abs(frame[i]-lastFrame[i]);
       }
       if(diff<1000){ 
         malpracticeCount++;
         console.warn("⚠️ Malpractice: Camera possibly covered or frozen!");
       }
     }
     lastFrame = frame;
   },4000);

 }catch(e){
   alert("Camera access denied.");
 }
}

// --- FINISH EXAM ---
function finishExam(){
 clearInterval(timer);
 let adjustedScore=Math.max(score - Math.min(malpracticeCount,score),0);
 alert(`Exam Finished!
Score: ${score}/${questions.length}
Malpractice Count: ${malpracticeCount}
Final Score: ${adjustedScore}`);
}
</script>
</body>
</html>